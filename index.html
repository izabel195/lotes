<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Romaneio</title>
  <style>
    :root{
      --bg:#f7f7fb; 
      --fg:#1f2937; 
      --muted:#6b7280; 
      --brand:#2563eb; 
      --card:#ffffff; 
      --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--fg);
    }
    header{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,#ffffff 0%,#ffffffd9 70%,#ffffff00);
      backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--line);
      z-index:5;
    }
    .wrap{max-width:1100px;margin:auto;padding:16px}
    h1{margin:0;font-size:clamp(18px,2.6vw,26px)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:820px){.g2,.g3,.g4{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;background:#fff;color:var(--fg);font-size:14px
    }
    textarea{min-height:84px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .btn{
      appearance:none;border:1px solid transparent;border-radius:12px;
      padding:10px 14px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer
    }
    .btn.secondary{background:#fff;color:var(--fg);border-color:var(--line)}
    .btn.ghost{background:transparent;color:var(--brand);border-color:var(--brand)}
    .btn.small{font-size:12px;padding:6px 10px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    th{font-weight:700;background:#fafafa}
    tfoot td{font-weight:700}
    .row-actions button{margin-right:6px}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{font-size:12px;border:1px solid var(--line);padding:6px 8px;border-radius:999px;background:#fff}
    h3{margin:16px 0 8px 0}
    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
    .actions.end{justify-content:flex-end;margin-top:14px}
    .table-wrap{overflow-x:auto;border:1px solid var(--line);border-radius:12px}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal-content{background:#fff;padding:20px;border-radius:12px;max-width:90%;width:100%;max-height:90vh;overflow-y:auto}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    .modal-section{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--line)}
    .edit-item-row{border-bottom:1px solid #eee;padding:10px 0}
    .edit-item-row:last-child{border-bottom:none}
    .edit-table {width:100%;border-collapse:collapse;margin-top:10px}
    .edit-table th, .edit-table td {padding:8px;border:1px solid #ddd}
    .edit-table input, .edit-table select {width:100%;padding:6px;border:1px solid #ccc;border-radius:4px}

    /* ===== Layout impressão ===== */
    @media print {
      header,.actions,.no-print,#salvarRomaneio{display:none!important}
      body{background:#fff!important;-webkit-print-color-adjust:exact!important;color-adjust:exact!important}
      .card{box-shadow:none!important;border:1px solid #000!important;page-break-inside:avoid}
      table,th,td{border:1px solid #000!important}
      th{background:#f0f0f0!important;-webkit-print-color-adjust:exact!important}
      .table-wrap{border:1px solid #000!important}
      table{width:100%;border-collapse:collapse}
      th,td{padding:6px;font-size:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <h1>Romaneio</h1>
      <div class="tags">
        <span class="tag">Importar XML NFe</span>
        <span class="tag">Impressão</span>
        <span class="tag">Firestore</span>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="gap:20px">
    <section class="card" id="card-romaneio">
      <div class="grid g2" style="align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo" id="remetenteLogo" style="width:56px;height:56px;border-radius:14px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-weight:800">MD</div>
          <div>
            <select id="remetenteSelect" style="width:100%;padding:6px;font-weight:600;">
              <option value="MARIA DIVINA AEROPIPA">MARIA DIVINA AEROPIPA</option>
              <option value="JPL">JPL</option>
            </select>
            <div class="muted" id="remetenteEndereco" style="font-size:13px">R. Jacirendi, 574, Anexo 582 — Tatuapé — São Paulo/SP — 03080-000</div>
            <div class="muted" id="remetenteTel" style="font-size:13px">Tel: 11 94024-0545</div>
          </div>
        </div>
        
        <div style="text-align:right">
          <div style="font-weight:700">ROMANEIO</div>
        </div>
      </div>

      <div class="grid g4">
        <div><label>Número NFE</label><input id="nfeNumero" placeholder="000000" /></div>
        <div><label>Data NFE</label><input id="nfeData" type="date" /></div>
        <div><label>Nº Remessa</label><input id="remessaNumero" placeholder="00000" /></div>
        <div><label>Faturamento</label><input id="faturamento" placeholder="000000" /></div>
      </div>

      <div class="grid g2">
        <div><label>Comprador</label><textarea id="comprador" placeholder="Nome, CNPJ/CPF, endereço"></textarea></div>
        <div><label>Recebedor</label><textarea id="recebedor" placeholder="Nome/Setor, endereço de entrega"></textarea></div>
      </div>

      <h3>Itens</h3>
      <div class="actions">
        <button class="btn" id="addItem">+ Adicionar item</button>
        <button class="btn secondary" id="clearItems">Limpar itens</button>
        <input type="file" id="uploadXML" accept=".xml" class="no-print" />
        <button class="btn ghost" id="printRomaneio">Imprimir</button>
        <button class="btn" id="salvarRomaneio">Salvar no Firestore</button>
      </div>

      <div class="table-wrap">
        <table id="itensTable">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Cód. Produto</th>
              <th>Descrição do Produto</th>
              <th>Nº do Lote</th>
              <th>Tipo de Carga</th>
              <th>Qtd Volumes</th>
              <th>U.M</th>
              <th>Peso Líq.</th>
              <th>Peso Bruto</th>
              <th>L (cm)</th>
              <th>A (cm)</th>
              <th>C (cm)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="5">Totais</td>
              <td id="totalVolumes">0</td>
              <td>—</td>
              <td id="totalLiq">0</td>
              <td id="totalBruto">0</td>
              <td colspan="3">—</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card" id="lista-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <h3 style="margin:0">Romaneios Salvos</h3>
        <button class="btn secondary" id="recarregar">Recarregar</button>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="listaRomaneios">
          <thead><tr><th>Resumo</th><th style="width:1%">Ação</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
   </main>

  <!-- Template item -->
  <template id="tpl-item">
    <tr data-visible="yes">
      <td>
        <select data-field="produto" class="produto-select">
          <option value="">Selecione um produto</option>
          <option value="Copo 80ml">Copo 80ml</option>
          <option value="Copo 100ml">Copo 100ml</option>
          <option value="Copo 220ml">Copo 220ml</option>
          <option value="Copo 300ml">Copo 300ml</option>
          <option value="Copo 400ml">Copo 400ml</option>
          <option value="Copo 500ml">Copo 500ml</option>
          <option value="Pote 100ml">Pote 100ml</option>
          <option value="Pote 250ml">Pote 250ml</option>
          <option value="Pote 590ml">Pote 590ml</option>
          <option value="Pote 920ml">Pote 920ml</option>
          <option value="CANUDO 10x210mm">CANUDO 10x210mm</option>
          <option value="CANUDO 10x298mm">CANUDO 10x298mm</option>
          <option value="CANUDO 08x210mm">CANUDO 08x210mm</option>
          <option value="CANUDO 08x110mm">CANUDO 08x110mm</option>
          <option value="CANUDO 05x240mm">CANUDO 05x240mm</option>
          <option value="CANUDO 05x197mm">CANUDO 05x197mm</option>
          <option value="SOLAPA 12">SOLAPA 12</option>
          <option value="SOLAPA 22">SOLAPA 22</option>
          <option value="CAIXA S/ INFO">CAIXA S/ INFO</option>
          <option value="OUTRO">OUTRO (personalizar)</option>
        </select>
      </td>
      <td><input placeholder="Cód" data-field="cod"/></td>
      <td><input placeholder="Descrição" data-field="descricao"/></td>
      <td><input placeholder="Lote" data-field="lote"/></td>
      <td><input placeholder="Tipo" data-field="tipo"/></td>
      <td><input type="number" min="0" step="1" value="0" data-field="volumes"/></td>
      <td><select data-field="um"><option>KG</option><option>UN</option><option>PC</option><option>CXS</option></select></td>
      <td><input type="number" min="0" step="0.01" value="0" data-field="pesoLiq"/></td>
      <td><input type="number" min="0" step="0.01" value="0" data-field="pesoBruto"/></td>
      <td><input type="number" min="0" step="0.01" value="0" data-field="dimL"/></td>
      <td><input type="number" min="0" step="0.01" value="0" data-field="dimA"/></td>
      <td><input type="number" min="0" step="0.01" value="0" data-field="dimC"/></td>
      <td class="row-actions">
        <button class="btn secondary" data-action="dup">Duplicar</button>
        <button class="btn secondary" data-action="del">Remover</button>
      </td>
    </tr>
  </template>

  <!-- Modal de edição -->
  <div id="editModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3>Editar Romaneio</h3>
      <div id="modalForm"></div>
      <div class="modal-actions">
        <button class="btn secondary" id="cancelEdit">Cancelar</button>
        <button class="btn" id="saveEdit">Salvar Alterações</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK + App -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp,
      doc, updateDoc, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // === CONFIGURAÇÃO DO FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCse9Zq2XdjUwN91pzNxF5pItSVR9b2fJ8",
      authDomain: "lote-de-pido.firebaseapp.com",
      projectId: "lote-de-pido",
      storageBucket: "lote-de-pido.firebasestorage.app",
      messagingSenderId: "273534472187",
      appId: "1:273534472187:web:b35eca45015f3c27fe055e",
      measurementId: "G-YC45VZ79H4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Dados fixos de remetente
    const empresas = {
      'MARIA DIVINA AEROPIPA': { nome:'MARIA DIVINA AEROPIPA', endereco:'R. Jacirendi, 574, Anexo 582 — Tatuapé — São Paulo/SP — 03080-000', telefone:'11 94024-0545', logo:'MD' },
      'JPL': { nome:'JPL', endereco:'R. Jacirendi, 574, Anexo 582 — Tatuapé — São Paulo/SP — 03080-000', telefone:'11 12345-6789', logo:'JPL' }
    };

    // Dados de dimensões automáticas
    const dimensoesProdutos = {
      'Copo 80ml': { L: 23.5, A: 29.5, C: 35 },
      'Copo 100ml': { L: 32.05, A: 27, C: 39 },
      'Copo 220ml': { L: 37, A: 28, C: 39.5 },
      'Copo 300ml': { L: 40, A: 32.5, C: 40 },
      'Copo 400ml': { L: 37, A: 46, C: 51.3 },
      'Copo 500ml': { L: 0, A: 0, C: 0 },
      'Pote 100ml': { L: 35.5, A: 21.5, C: 38 },
      'Pote 250ml': { L: 47, A: 38, C: 48 },
      'Pote 590ml': { L: 50.5, A: 38.5, C: 33.5 },
      'Pote 920ml': { L: 0, A: 0, C: 0 },
      'CANUDO 10x210mm': { L: 56, A: 25, C: 25 },
      'CANUDO 10x298mm': { L: 67, A: 37, C: 32 },
      'CANUDO 08x210mm': { L: 36, A: 25, C: 25 },
      'CANUDO 08x110mm': { L: 36, A: 21, C: 24 },
      'CANUDO 05x240mm': { L: 36, A: 22, C: 29 },
      'CANUDO 05x197mm': { L: 37, A: 21, C: 24 },
      'SOLAPA 12': { L: 32, A: 15, C: 21 },
      'SOLAPA 22': { L: 30, A: 28, C: 21 },
      'CAIXA S/ INFO': { L: 50.5, A: 37.5, C: 47 }
    };
    
    // ====== ELEMENTOS
    const els = {
      card: document.getElementById('card-romaneio'),
      itensTable: document.querySelector('#itensTable tbody'),
      tplItem: document.getElementById('tpl-item'),
      addItem: document.getElementById('addItem'),
      clearItems: document.getElementById('clearItems'),
      salvarRomaneio: document.getElementById('salvarRomaneio'),
      recarregar: document.getElementById('recarregar'),
      listaRomaneios: document.querySelector('#listaRomaneios tbody'),
      nfeNumero: document.getElementById('nfeNumero'),
      nfeData: document.getElementById('nfeData'),
      remessaNumero: document.getElementById('remessaNumero'),
      faturamento: document.getElementById('faturamento'),
      comprador: document.getElementById('comprador'),
      recebedor: document.getElementById('recebedor'),
      remetenteSelect: document.getElementById('remetenteSelect'),
      remetenteLogo: document.getElementById('remetenteLogo'),
      remetenteEndereco: document.getElementById('remetenteEndereco'),
      remetenteTel: document.getElementById('remetenteTel'),
      uploadXML: document.getElementById('uploadXML'),
      printRomaneio: document.getElementById('printRomaneio'),
      totalVolumes: document.getElementById('totalVolumes'),
      totalLiq: document.getElementById('totalLiq'),
      totalBruto: document.getElementById('totalBruto'),
      editModal: document.getElementById('editModal'),
      modalForm: document.getElementById('modalForm'),
      cancelEdit: document.getElementById('cancelEdit'),
      saveEdit: document.getElementById('saveEdit')
    };

    // Variável para armazenar o documento atual sendo editado
    let currentEditDoc = null;

    // ====== FUNÇÕES DE TABELA / TOTAIS
    function atualizarTotais(){
      let volumes=0, liq=0, bruto=0;
      els.itensTable.querySelectorAll('tr[data-visible="yes"]').forEach(tr=>{
        volumes += parseFloat(tr.querySelector('[data-field="volumes"]').value)||0;
        liq     += parseFloat(tr.querySelector('[data-field="pesoLiq"]').value)||0;
        bruto   += parseFloat(tr.querySelector('[data-field="pesoBruto"]').value)||0;
      });
      els.totalVolumes.textContent = volumes;
      els.totalLiq.textContent = liq.toFixed(2);
      els.totalBruto.textContent = bruto.toFixed(2);
    }

    function aplicarDimensoesAutomáticas(selectElement) {
      const tr = selectElement.closest('tr');
      const produto = selectElement.value;
      
      if (dimensoesProdutos[produto]) {
        const dims = dimensoesProdutos[produto];
        tr.querySelector('[data-field="dimL"]').value = dims.L;
        tr.querySelector('[data-field="dimA"]').value = dims.A;
        tr.querySelector('[data-field="dimC"]').value = dims.C;
      }
    }

    function criarItem(){
      const clone = els.tplItem.content.cloneNode(true);
      const tr = clone.querySelector('tr');
      
      // Adicionar evento para aplicar dimensões automáticas
      const produtoSelect = tr.querySelector('.produto-select');
      produtoSelect.addEventListener('change', function() {
        aplicarDimensoesAutomáticas(this);
      });
      
      tr.querySelectorAll('input,select').forEach(inp=>{ 
        if (!inp.classList.contains('produto-select')) {
          inp.addEventListener('input', atualizarTotais); 
        }
      });
      
      tr.querySelector('[data-action="del"]').addEventListener('click', ()=>{ tr.remove(); atualizarTotais(); });
      tr.querySelector('[data-action="dup"]').addEventListener('click', ()=>{ 
        const novo = criarItem();
        // copia valores da linha
        tr.querySelectorAll('[data-field]').forEach(i=>{
          const f = i.dataset.field;
          const tgt = novo.querySelector(`[data-field="${f}"]`);
          if(tgt) tgt.value = i.value;
        });
        // copia também o valor do select de produto
        const produtoVal = tr.querySelector('.produto-select').value;
        novo.querySelector('.produto-select').value = produtoVal;
        atualizarTotais();
      });
      els.itensTable.appendChild(tr);
      return tr;
    }

    els.addItem.addEventListener('click', ()=>criarItem());
    els.clearItems.addEventListener('click', ()=>{ els.itensTable.innerHTML=''; atualizarTotais(); });

    // ====== REMETENTE (logo/endereço/tel)
    els.remetenteSelect.addEventListener('change', ()=>{
      const empresaSelecionada = els.remetenteSelect.value;
      const r = empresas[empresaSelecionada];
      if(r){
        els.remetenteLogo.textContent = r.logo;
        els.remetenteEndereco.textContent = r.endereco;
        els.remetenteTel.textContent = 'Tel: ' + r.telefone;
      }
    });

    // ====== IMPORTAÇÃO DE XML NFe
    function tx(xml, candidates){
      for(const sel of candidates){
        const node = xml.querySelector(sel);
        if(node && node.textContent) return node.textContent;
      }
      return '';
    }

    function parseItems(xml){
      const dets = xml.querySelectorAll('det, infNFe > det, NFe infNFe det');
      if(dets.length) return dets;
      // fallback: procurar por qualquer nó chamado 'det'
      return xml.getElementsByTagName('det');
    }

    // FUNÇÃO PARA CONVERTER QUANTIDADE EM CAIXAS
    function converterParaCaixas(quantidade) {
      if (quantidade >= 1000) {
        return {
          valor: (quantidade / 1000).toFixed(3),
          unidade: 'CXS'
        };
      }
      return {
        valor: quantidade,
        unidade: 'UN'
      };
    }

    // FUNÇÃO PARA DISTRIBUIR PESO ENTRE OS ITENS
    function distribuirPesoEntreItens(itens, pesoTotal) {
      if (!itens.length || pesoTotal <= 0) return itens;
      
      // Calcular o total de unidades para distribuir proporcionalmente
      const totalUnidades = itens.reduce((total, item) => total + parseFloat(item.volumes || 0), 0);
      
      if (totalUnidades <= 0) return itens;
      
      // Distribuir o peso proporcionalmente entre os itens
      return itens.map(item => {
        const proporcao = parseFloat(item.volumes || 0) / totalUnidades;
        const pesoProporcional = (pesoTotal * proporcao).toFixed(2);
        
        return {
          ...item,
          pesoLiq: pesoProporcional,
          pesoBruto: pesoProporcional
        };
      });
    }

    els.uploadXML.addEventListener('change', function(e){
      const file = e.target.files?.[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = (ev)=>{
        const parser = new DOMParser();
        const xml = parser.parseFromString(ev.target.result, "text/xml");

        // Número e data
        els.nfeNumero.value = tx(xml, ["ide > nNF","nfeProc ide nNF","infNFe > ide > nNF"]);
        const dhEmi = tx(xml, ["ide > dhEmi","ide > dEmi","infNFe > ide > dhEmi","infNFe > ide > dEmi"]);
        els.nfeData.value = dhEmi ? (dhEmi.includes('T') ? dhEmi.split('T')[0] : dhEmi) : "";

        // Comprador
        const compradorNome = tx(xml, ["dest > xNome","infNFe > dest > xNome"]);
        const compradorCNPJ = tx(xml, ["dest > CNPJ","infNFe > dest > CNPJ","dest > CPF","infNFe > dest > CPF"]);
        const end = [
          tx(xml, ["enderDest > xLgr","infNFe > dest > enderDest > xLgr"]),
          tx(xml, ["enderDest > nro","infNFe > dest > enderDest > nro"]),
          tx(xml, ["enderDest > xBairro","infNFe > dest > enderDest > xBairro"]),
          tx(xml, ["enderDest > xMun","infNFe > dest > enderDest > xMun"]),
          tx(xml, ["enderDest > UF","infNFe > dest > enderDest > UF"]),
          tx(xml, ["enderDest > CEP","infNFe > dest > enderDest > CEP"])
        ].filter(Boolean).join(", ");
        els.comprador.value = `${compradorNome}\nCNPJ/CPF: ${compradorCNPJ}\n${end}`;

        // Recebedor (se existir entrega)
        const recebedorNome = tx(xml, ["entrega > xNome","infNFe > entrega > xNome"]);
        els.recebedor.value = recebedorNome || "";

        // Nome da empresa (remetente) - extrair do XML
        const remetenteNome = tx(xml, ["emit > xNome","infNFe > emit > xNome"]);
        if (remetenteNome) {
          // Verificar se o nome da empresa existe no nosso objeto empresas
          const empresaEncontrada = Object.keys(empresas).find(key => 
            remetenteNome.toUpperCase().includes(key.toUpperCase())
          );
          
          if (empresaEncontrada) {
            els.remetenteSelect.value = empresaEncontrada;
            // Disparar evento change para atualizar logo e endereço
            const event = new Event('change');
            els.remetenteSelect.dispatchEvent(event);
          }
        }

        // Obter peso total da NFe
        const pesoBrutoTotal = parseFloat(tx(xml, ["pesoB", "total pesoB", "infNFe total pesoB"]) || "0");
        const pesoLiqTotal = parseFloat(tx(xml, ["pesoL", "total pesoL", "infNFe total pesoL"]) || "0");
        
        // Usar o maior peso disponível (bruto ou líquido)
        const pesoTotal = pesoBrutoTotal > 0 ? pesoBrutoTotal : pesoLiqTotal;

        // Itens
        els.itensTable.innerHTML = "";
        const dets = parseItems(xml);
        
        // Primeiro, coletar todos os itens
        const itensColetados = Array.from(dets).map(det => {
          const prod = det.querySelector('prod');
          const xProd = prod?.querySelector('xProd')?.textContent || "";
          const cProd = prod?.querySelector('cProd')?.textContent || "";
          const ncm   = prod?.querySelector('NCM')?.textContent || "";
          const qCom  = parseFloat(prod?.querySelector('qCom')?.textContent || "0");
          const uCom  = prod?.querySelector('uCom')?.textContent || "UN";
          
          // Converter quantidade para caixas se necessário
          const quantidadeConvertida = converterParaCaixas(qCom);

          return {
            produto: xProd,
            cod: cProd,
            descricao: xProd, // Usar a descrição do produto (xProd) em vez do NCM
            volumes: quantidadeConvertida.valor,
            um: quantidadeConvertida.unidade,
            lote: "",
            tipo: "",
            pesoLiq: 0,
            pesoBruto: 0,
            dimL: 0,
            dimA: 0,
            dimC: 0
          };
        });

        // Distribuir o peso total entre os itens
        const itensComPeso = distribuirPesoEntreItens(itensColetados, pesoTotal);

        // Adicionar itens à tabela
        itensComPeso.forEach(item => {
          const tr = criarItem();
          
          // Preencher com dados do XML
          tr.querySelector('[data-field="produto"]').value   = item.produto;
          tr.querySelector('[data-field="cod"]').value       = item.cod;
          tr.querySelector('[data-field="descricao"]').value = item.descricao; // Descrição do produto
          tr.querySelector('[data-field="volumes"]').value   = item.volumes;
          tr.querySelector('[data-field="um"]').value        = item.um;
          tr.querySelector('[data-field="pesoLiq"]').value   = item.pesoLiq;
          tr.querySelector('[data-field="pesoBruto"]').value = item.pesoBruto;

          // Lote e dimensões ficam para preenchimento manual
          tr.querySelector('[data-field="lote"]').value = item.lote;
          tr.querySelector('[data-field="tipo"]').value = item.tipo;
          tr.querySelector('[data-field="dimL"]').value = item.dimL;
          tr.querySelector('[data-field="dimA"]').value = item.dimA;
          tr.querySelector('[data-field="dimC"]').value = item.dimC;
        });

        atualizarTotais();
        alert("XML importado com sucesso! O peso total foi distribuído entre os itens.");
      };
      reader.readAsText(file);
    });

    // ====== SALVAR NO FIRESTORE
    els.salvarRomaneio.addEventListener('click', async ()=>{
      const itens = Array.from(els.itensTable.querySelectorAll('tr')).map(tr=>{
        const obj={};
        tr.querySelectorAll('input, select').forEach(i=>{
          if (i.dataset.field) {
            obj[i.dataset.field]=i.value;
          }
        });
        // normaliza numéricos
        obj.volumes   = +obj.volumes || 0;
        obj.pesoLiq   = +obj.pesoLiq || 0;
        obj.pesoBruto = +obj.pesoBruto || 0;
        obj.dimL      = +obj.dimL || 0;
        obj.dimA      = +obj.dimA || 0;
        obj.dimC      = +obj.dimC || 0;
        return obj;
      });

      const data = {
        nfeNumero: els.nfeNumero.value.trim(),
        nfeData: els.nfeData.value,
        remessaNumero: els.remessaNumero.value.trim(),
        faturamento: els.faturamento.value.trim(),
        comprador: els.comprador.value.trim(),
        recebedor: els.recebedor.value.trim(),
        remetente: empresas[els.remetenteSelect.value] || {},
        itens,
        totais: {
          volumes: +els.totalVolumes.textContent || 0,
          pesoLiq: +(els.totalLiq.textContent || "0"),
          pesoBruto: +(els.totalBruto.textContent || "0"),
        },
        criadoEm: serverTimestamp()
      };

      try{
        await addDoc(collection(db,'romaneios'), data);
        alert('Romaneio salvo no Firestore!');
        carregarRomaneios();
      }catch(e){
        console.error(e);
        alert('Erro ao salvar no Firestore.');
      }
    });

    // ====== FUNÇÕES DE EDIÇÃO
    function preencherFormularioEdicao(data) {
      els.modalForm.innerHTML = `
        <div class="modal-section">
          <h4>Informações Principais</h4>
          <div class="grid g2">
            <div><label>Número NFE</label><input id="editNfeNumero" value="${data.nfeNumero || ''}" /></div>
            <div><label>Data NFE</label><input id="editNfeData" type="date" value="${data.nfeData || ''}" /></div>
          </div>
          <div class="grid g2">
            <div><label>Nº Remessa</label><input id="editRemessaNumero" value="${data.remessaNumero || ''}" /></div>
            <div><label>Faturamento</label><input id="editFaturamento" value="${data.faturamento || ''}" /></div>
          </div>
          <div class="grid g2">
            <div><label>Comprador</label><textarea id="editComprador">${data.comprador || ''}</textarea></div>
            <div><label>Recebedor</label><textarea id="editRecebedor">${data.recebedor || ''}</textarea></div>
          </div>
        </div>
        
        <div class="modal-section">
          <h4>Itens do Romaneio</h4>
          <div class="table-wrap">
            <table class="edit-table">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Código</th>
                  <th>Descrição</th>
                  <th>Lote</th>
                  <th>Tipo</th>
                  <th>Qtd</th>
                  <th>UM</th>
                  <th>Peso Liq</th>
                  <th>Peso Bruto</th>
                  <th>L (cm)</th>
                  <th>A (cm)</th>
                  <th>C (cm)</th>
                </tr>
              </thead>
              <tbody id="editItensContainer"></tbody>
            </table>
          </div>
        </div>
      `;
      
      // Preencher itens
      const itensContainer = document.getElementById('editItensContainer');
      itensContainer.innerHTML = '';
      
      if (data.itens && data.itens.length > 0) {
        data.itens.forEach((item, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="text" value="${item.produto || ''}" data-item-index="${index}" data-field="produto"></td>
            <td><input type="text" value="${item.cod || ''}" data-item-index="${index}" data-field="cod"></td>
            <td><input type="text" value="${item.descricao || ''}" data-item-index="${index}" data-field="descricao"></td>
            <td><input type="text" value="${item.lote || ''}" data-item-index="${index}" data-field="lote"></td>
            <td><input type="text" value="${item.tipo || ''}" data-item-index="${index}" data-field="tipo"></td>
            <td><input type="number" value="${item.volumes || 0}" data-item-index="${index}" data-field="volumes"></td>
            <td>
              <select data-item-index="${index}" data-field="um">
                <option value="KG" ${item.um === 'KG' ? 'selected' : ''}>KG</option>
                <option value="UN" ${item.um === 'UN' ? 'selected' : ''}>UN</option>
                <option value="PC" ${item.um === 'PC' ? 'selected' : ''}>PC</option>
                <option value="CXS" ${item.um === 'CXS' ? 'selected' : ''}>CXS</option>
              </select>
            </td>
            <td><input type="number" step="0.01" value="${item.pesoLiq || 0}" data-item-index="${index}" data-field="pesoLiq"></td>
            <td><input type="number" step="0.01" value="${item.pesoBruto || 0}" data-item-index="${index}" data-field="pesoBruto"></td>
            <td><input type="number" step="0.01" value="${item.dimL || 0}" data-item-index="${index}" data-field="dimL"></td>
            <td><input type="number" step="0.01" value="${item.dimA || 0}" data-item-index="${index}" data-field="dimA"></td>
            <td><input type="number" step="0.01" value="${item.dimC || 0}" data-item-index="${index}" data-field="dimC"></td>
          `;
          itensContainer.appendChild(tr);
        });
      } else {
        itensContainer.innerHTML = '<tr><td colspan="12" style="text-align:center">Nenhum item encontrado</td></tr>';
      }
    }

    async function abrirModalEdicao(docId, data) {
      currentEditDoc = { id: docId, data: data };
      preencherFormularioEdicao(data);
      els.editModal.style.display = 'flex';
    }

    async function salvarEdicao() {
      if (!currentEditDoc) return;
      
      // Coletar dados do formulário principal
      const updatedData = {
        nfeNumero: document.getElementById('editNfeNumero').value,
        nfeData: document.getElementById('editNfeData').value,
        remessaNumero: document.getElementById('editRemessaNumero').value,
        faturamento: document.getElementById('editFaturamento').value,
        comprador: document.getElementById('editComprador').value,
        recebedor: document.getElementById('editRecebedor').value,
        remetente: currentEditDoc.data.remetente,
        // Coletar itens editados
        itens: [],
        totais: {
          volumes: 0,
          pesoLiq: 0,
          pesoBruto: 0
        }
      };

      // Coletar dados dos itens
      const itemInputs = document.querySelectorAll('#editItensContainer [data-item-index]');
      const itemsByIndex = {};
      
      itemInputs.forEach(input => {
        const index = input.getAttribute('data-item-index');
        const field = input.getAttribute('data-field');
        const value = input.value;
        
        if (!itemsByIndex[index]) {
          itemsByIndex[index] = {};
        }
        
        itemsByIndex[index][field] = value;
      });
      
      // Processar itens e calcular totais
      Object.values(itemsByIndex).forEach(item => {
        // Converter valores numéricos
        const volumes = parseFloat(item.volumes) || 0;
        const pesoLiq = parseFloat(item.pesoLiq) || 0;
        const pesoBruto = parseFloat(item.pesoBruto) || 0;
        const dimL = parseFloat(item.dimL) || 0;
        const dimA = parseFloat(item.dimA) || 0;
        const dimC = parseFloat(item.dimC) || 0;
        
        // Adicionar ao array de itens
        updatedData.itens.push({
          produto: item.produto || '',
          cod: item.cod || '',
          descricao: item.descricao || '',
          lote: item.lote || '',
          tipo: item.tipo || '',
          volumes: volumes,
          um: item.um || 'UN',
          pesoLiq: pesoLiq,
          pesoBruto: pesoBruto,
          dimL: dimL,
          dimA: dimA,
          dimC: dimC
        });
        
        // Somar totais
        updatedData.totais.volumes += volumes;
        updatedData.totais.pesoLiq += pesoLiq;
        updatedData.totais.pesoBruto += pesoBruto;
      });

      try {
        const docRef = doc(db, 'romaneios', currentEditDoc.id);
        await updateDoc(docRef, updatedData);
        alert('Romaneio atualizado com sucesso!');
        els.editModal.style.display = 'none';
        carregarRomaneios();
      } catch (e) {
        console.error(e);
        alert('Erro ao atualizar o romaneio.');
      }
    }
    

    // ====== LISTAR SALVOS (com botão imprimir e editar)
    async function carregarRomaneios(){
      els.listaRomaneios.innerHTML = '<tr><td colspan="2">Carregando...</td></tr>';
      try{
        const qy = query(collection(db,'romaneios'), orderBy('criadoEm','desc'));
        const snap = await getDocs(qy);
        if(snap.empty){
          els.listaRomaneios.innerHTML = '<tr><td colspan="2" style="text-align:center">Nenhum romaneio salvo</td></tr>';
          return;
        }
        els.listaRomaneios.innerHTML = '';
        snap.forEach(doc=>{
          const data = doc.data();
          const tr = document.createElement('tr');

          const tdInfo = document.createElement('td');
          tdInfo.innerHTML = `
            <div><strong>NFe:</strong> ${data.nfeNumero||''} • <strong>Data:</strong> ${data.nfeData||''}</div>
            <div class="muted" style="font-size:12px">${(data.remetente?.nome)||''} – ${data.comprador?.split?.('\n')?.[0]||''}</div>
          `;

          const tdAcoes = document.createElement('td');
          tdAcoes.style.display = 'flex';
          tdAcoes.style.gap = '6px';
          
          const btnImp = document.createElement('button');
          btnImp.className='btn small secondary';
          btnImp.textContent='Imprimir';
          btnImp.addEventListener('click', ()=> imprimirRomaneioHTML(data));
          
          const btnEdit = document.createElement('button');
          btnEdit.className='btn small';
          btnEdit.textContent='Editar';
          btnEdit.addEventListener('click', ()=> abrirModalEdicao(doc.id, data));
          
          const btnDel = document.createElement('button');
          btnDel.className='btn small secondary';
          btnDel.textContent='Excluir';
          btnDel.addEventListener('click', async ()=> {
            if(confirm('Tem certeza que deseja excluir este romaneio?')) {
              try {
                await deleteDoc(doc(db, 'romaneios', doc.id));
                carregarRomaneios();
              } catch (e) {
                console.error(e);
                alert('Erro ao excluir romaneio.');
              }
            }
          });
          
          tdAcoes.appendChild(btnImp);
          tdAcoes.appendChild(btnEdit);
          tdAcoes.appendChild(btnDel);

          tr.appendChild(tdInfo);
          tr.appendChild(tdAcoes);
          els.listaRomaneios.appendChild(tr);
        });
      }catch(e){
        console.error(e);
        els.listaRomaneios.innerHTML = '<tr><td colspan="2">Erro ao carregar</td></tr>';
      }
    }

    // Event listeners para o modal de edição
    els.cancelEdit.addEventListener('click', () => {
      els.editModal.style.display = 'none';
      currentEditDoc = null;
    });
    
    els.saveEdit.addEventListener('click', salvarEdicao);

    els.recarregar?.addEventListener('click', carregarRomaneios);
    carregarRomaneios();

    // ====== IMPRESSÃO (mantém layout)
    function cloneToPrint(data) {
      const card = document.getElementById('card-romaneio').cloneNode(true);

      // Preenche cabeçalho
      card.querySelector('#nfeNumero').value = data?.nfeNumero || els.nfeNumero.value || '';
      card.querySelector('#nfeData').value = data?.nfeData || els.nfeData.value || '';
      card.querySelector('#remessaNumero').value = data?.remessaNumero || els.remessaNumero.value || '';
      card.querySelector('#faturamento').value = data?.faturamento || els.faturamento.value || '';
      card.querySelector('#comprador').value = data?.comprador || els.comprador.value || '';
      card.querySelector('#recebedor').value = data?.recebedor || els.recebedor.value || '';

      // ====== Remetente (logo/nome/endereço/tel)
      const empresaNome = data?.remetente?.nome || els.remetenteSelect.value;
      const remetenteAtual = empresas[empresaNome] || {};
      
      // Atualiza o nome da empresa no cabeçalho - substitui o select por um div com o nome
      const remetenteSelect = card.querySelector('#remetenteSelect');
      const nomeEmpresaDiv = document.createElement('div');
      nomeEmpresaDiv.textContent = empresaNome;
      nomeEmpresaDiv.style.fontWeight = '600';
      nomeEmpresaDiv.style.padding = '6px';
      remetenteSelect.parentNode.replaceChild(nomeEmpresaDiv, remetenteSelect);
      
      // Atualiza logo, endereço e telefone
      card.querySelector('#remetenteLogo').textContent = remetenteAtual.logo || 'MD';
      card.querySelector('#remetenteEndereco').textContent = remetenteAtual.endereco || '';
      card.querySelector('#remetenteTel').textContent = remetenteAtual.telefone ? 'Tel: ' + remetenteAtual.telefone : '';

      // Tabela de itens
      const tbody = card.querySelector('#itensTable tbody');
      tbody.innerHTML = '';
      const items = data?.itens?.length
        ? data.itens
        : Array.from(els.itensTable.querySelectorAll('tr')).map(tr => {
            const obj = {};
            tr.querySelectorAll('[data-field]').forEach(i => obj[i.dataset.field] = i.value);
            return obj;
          });

      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.produto || ''}</td>
          <td>${item.cod || ''}</td>
          <td>${item.descricao || ''}</td>
          <td>${item.lote || ''}</td>
          <td>${item.tipo || ''}</td>
          <td>${item.volumes || 0}</td>
          <td>${item.um || ''}</td>
          <td>${item.pesoLiq || 0}</td>
          <td>${item.pesoBruto || 0}</td>
          <td>${item.dimL || 0}</td>
          <td>${item.dimA || 0}</td>
          <td>${item.dimC || 0}</td>
          <td></td>
        `;
        tbody.appendChild(tr);
      });

      // Totais
      const tv = items.reduce((a, i) => a + (+i.volumes || 0), 0);
      const tl = items.reduce((a, i) => a + (+i.pesoLiq || 0), 0).toFixed(2);
      const tb = items.reduce((a, i) => a + (+i.pesoBruto || 0), 0).toFixed(2);
      card.querySelector('#totalVolumes').textContent = tv;
      card.querySelector('#totalLiq').textContent = tl;
      card.querySelector('#totalBruto').textContent = tb;

      // Substitui inputs/textarea/select por divs mantendo layout
      card.querySelectorAll('input, textarea, select, .actions, .row-actions').forEach(el => {
        if (el.classList?.contains('actions') || el.classList?.contains('row-actions')) { 
          el.remove(); 
          return; 
        }
        if (el.tagName === 'SELECT') {
          const div = document.createElement('div');
          div.textContent = el.options[el.selectedIndex].text;
          const st = getComputedStyle(el);
          div.style.border = st.border; 
          div.style.padding = st.padding; 
          div.style.borderRadius = st.borderRadius;
          div.style.background = st.background; 
          div.style.fontSize = st.fontSize; 
          div.style.fontFamily = st.fontFamily;
          div.style.minHeight = st.height; 
          div.style.boxSizing = 'border-box';
          el.replaceWith(div);
          return;
        }
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          const div = document.createElement('div');
          div.textContent = el.value;
          const st = getComputedStyle(el);
          div.style.border = st.border; 
          div.style.padding = st.padding; 
          div.style.borderRadius = st.borderRadius;
          div.style.background = st.background; 
          div.style.fontSize = st.fontSize; 
          div.style.fontFamily = st.fontFamily;
          div.style.minHeight = st.height; 
          div.style.boxSizing = 'border-box'; 
          div.style.whiteSpace = 'pre-wrap';
          el.replaceWith(div);
        }
      });

      return card;
    }

    function abrirJanelaImpressao(card){
      const w = window.open();
      w.document.write('<html><head><title>Romaneio</title>');
      const styles = Array.from(document.querySelectorAll('style, link[rel="stylesheet"]'))
                        .map(s => s.outerHTML).join('');
      w.document.write(styles);
      w.document.write('</head><body>');
      w.document.write(card.outerHTML);
      w.document.write('</body></html>');
      w.document.close();
      w.focus();
      w.print();
      w.close();
    }

    function imprimirRomaneioHTML(data){
      const card = cloneToPrint(data);
      abrirJanelaImpressao(card);
    }

    // Botão imprimir do formulário atual
    els.printRomaneio.addEventListener('click', ()=>{
      imprimirRomaneioHTML(); // imprime o que está na tela
    });

    // Inicializar a lista de romaneios
    carregarRomaneios();
  </script>
</body>
</html>
