<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Bobinas</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 5px rgba(26, 115, 232, 0.4);
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #1669c1; }
    button.logout { background-color: #c0392b; }
    button.logout:hover { background-color: #a93226; }
    .remove-bobina-btn, .remove-produto-btn {
      background-color: #e74c3c;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      margin-top: 5px;
      font-size: 14px;
    }
    .remove-bobina-btn:hover, .remove-produto-btn:hover {
      background-color: #c0392b;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f1f1f1; }
    .produto-group {
      border: 2px solid #1a73e8;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      background-color: #ffffff;
    }
    .bobina-group {
      border: 1px dashed #999;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      background-color: #fefefe;
    }
    .hidden { display: none; }
    h2 { color: #1a73e8; }
    label { font-weight: bold; margin-top: 10px; display: block; }

    /* Logo no topo da impressão 
    @media print {
      body::before {
        content: "";
        display: block;
        width: 200px;      /* ajuste a largura 
        height: 100px;     /* ajuste a altura proporcional 
        margin: 0 auto 10px auto;
        background-image: url('./IMG/logo_kurma.jpg'); /* coloque sua logo na mesma pasta
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
    }
  */

 

  </style>
  <img src="./IMG/logo_kurma.jpg" alt="Logo" style="display:block; margin: 0 auto 15px auto; width: 200px; height: auto;" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="login-area">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="senha" placeholder="Senha" />
    <label><input type="checkbox" id="mostrarSenha" onchange="toggleSenha()" /> Mostrar senha</label>
    <button onclick="login()">Entrar</button>
    <button onclick="registrar()">Registrar</button>
  </div>

  <div id="app-area" class="hidden">
    <button class="logout" onclick="logout()">Sair</button>

    <input type="text" id="cliente" placeholder="Cliente" />
    <input type="text" id="numeroOS" placeholder="Número da OS" /> <!-- CAMPO ADICIONADO -->

    <div id="produtos-container"></div>
    <button onclick="adicionarProduto()">+ Adicionar Produto</button>
    <button onclick="salvarRegistros()">Salvar</button>

    <label>Filtrar por Cliente:</label>
    <select id="filtroCliente" onchange="filtrarTabela()">
      <option value="">Todos</option>
    </select>

    <label>Filtrar por Número da Venda:</label>
    <select id="filtroVenda" onchange="filtrarTabela()">
      <option value="">Todos</option>
    </select>

    <button onclick="imprimirClienteSelecionado()">Imprimir Seleção</button>

    <table id="tabelaRegistros">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Número da OS</th> <!-- COLUNA ADICIONADA -->
          <th>Número da Nota Fiscal</th>
          <th>Tipo de Embalagem</th>
          <th>Produto</th>
          <th>Dimensão da Embalagem (LxC)</th>
          <th>Peso Líquido (unit.)</th>
          <th>Peso Bruto</th>
          <th>Volume Total da Carga</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCse9Zq2XdjUwN91pzNxF5pItSVR9b2fJ8",
    authDomain: "lote-de-pido.firebaseapp.com",
    projectId: "lote-de-pido",
    storageBucket: "lote-de-pido.appspot.com",
    messagingSenderId: "273534472187",
    appId: "1:273534472187:web:b35eca45015f3c27fe055e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const produtosContainer = document.getElementById("produtos-container");
  let registros = [];

  // Dados produtos já com largura, comprimento e peso
  const produtosInfo = {
    "Copo 80ml": { largura:23.5, comprimento:29.5, peso:3.268 },
    "Copo 100ml": { largura:32.05, comprimento:27, peso:3.708 },
    "Copo 220ml": { largura:37, comprimento:28, peso:5.928 },
    "Copo 300ml": { largura:40, comprimento:32.5, peso:8.590 },
    "Copo 400ml": { largura:37, comprimento:46, peso:0 },
    "Copo 500ml": { largura:0, comprimento:0, peso:0 },
    "Pote 100ml": { largura:35.5, comprimento:21.5, peso:4.07 },
    "Pote 250ml": { largura:47, comprimento:38, peso:7.115 },
    "Pote 590ml": { largura:50.5, comprimento:38.5, peso:5.054 },
    "Canudo 10x210mm": { largura:56, comprimento:25, peso:4.000 },
    "Canudo 10x298mm": { largura:67, comprimento:37, peso:12.000 },
    "Canudo 08x210mm": { largura:36, comprimento:25, peso:3.000 },
    "Canudo 08x110mm": { largura:36, comprimento:21, peso:2.000 },
    "Canudo 05x240mm": { largura:36, comprimento:22, peso:3.000 },
    "Canudo 05x197mm": { largura:37, comprimento:21, peso:2.000 },
    "Solapa 12 05x197mm": { largura:32, comprimento:15, peso:2.000 },
    "Solapa 22 05x197mm": { largura:30, comprimento:28, peso:4.000 },
  };

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("app-area").classList.remove("hidden");
      carregarRegistrosEmTempoReal();
    } else {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("app-area").classList.add("hidden");
      registros = [];
      atualizarTabela();
      atualizarFiltro();
    }
  });

  function toggleSenha() {
    const senhaInput = document.getElementById("senha");
    senhaInput.type = senhaInput.type === "password" ? "text" : "password";
  }

  function login() {
    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;
    auth.signInWithEmailAndPassword(email, senha)
      .catch(e => alert("Erro ao entrar: " + e.message));
  }

  function registrar() {
    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;
    auth.createUserWithEmailAndPassword(email, senha)
      .then(() => alert("Conta criada com sucesso!"))
      .catch(e => alert("Erro ao registrar: " + e.message));
  }

  function logout() { auth.signOut(); }

  function adicionarProduto() {
    const divProduto = document.createElement("div");
    divProduto.classList.add("produto-group");

    // Opções de produto para o select
    const optionsProduto = Object.keys(produtosInfo).map(p => `<option value="${p}">${p}</option>`).join("");

    // Opções de tipo de embalagem (exemplo)
    const optionsEmbalagem = `
      <option value="">Selecione o Tipo de Embalagem</option>
      <option value="Caixa">Caixa</option>
      <option value="Saco">Saco</option>
      <option value="Envelope">Envelope</option>
      <option value="Outro">Outro</option>
    `;

    divProduto.innerHTML = `
      <input type="text" class="numeroNotaFiscal" placeholder="Número da Nota Fiscal" />

      <select class="tipoEmbalagem">
        ${optionsEmbalagem}
      </select>

      <select class="produto" onchange="preencherProduto(this)">
        <option value="">Selecione o Produto</option>
        ${optionsProduto}
      </select>

      <input type="text" class="dimensaoEmbalagem" placeholder="Dimensão da Embalagem (LxC)" readonly />

      <input type="number" step="0.01" class="pesoLiquido" placeholder="Peso Líquido (unit.)" readonly />
      <input type="number" step="0.01" class="pesoBruto" placeholder="Peso Bruto" readonly />
      <input type="number" step="0.01" min="0" class="volumeTotalCarga" placeholder="Volume Total da Carga" value="0" oninput="atualizarPesoBruto(this)" />

      <div class="bobinas-container"></div>
      <button type="button" onclick="adicionarBobina(this)">+ Adicionar Bobina</button>
      <button type="button" onclick="removerProduto(this)" class="remove-produto-btn">Remover Produto</button>
    `;

    produtosContainer.appendChild(divProduto);
    adicionarBobina(divProduto.querySelector(".bobinas-container"));
  }

  // Quando seleciona um produto, preenche peso, dimensao (LxC) e calcula peso bruto
  function preencherProduto(select) {
    const grupo = select.closest(".produto-group");
    const produto = produtosInfo[select.value];
    if (!produto) {
      grupo.querySelector(".dimensaoEmbalagem").value = "";
      grupo.querySelector(".pesoLiquido").value = "";
      grupo.querySelector(".pesoBruto").value = "";
      return;
    }

    // Preencher dimensao da embalagem concatenada LxC
    const dimensao = `${produto.largura} x ${produto.comprimento}`;
    grupo.querySelector(".dimensaoEmbalagem").value = dimensao;

    // Preencher peso líquido
    grupo.querySelector(".pesoLiquido").value = produto.peso;

    atualizarPesoBruto(grupo.querySelector(".volumeTotalCarga"));
  }

  // Atualiza o peso bruto (peso líquido * volume)
  function atualizarPesoBruto(element) {
    const grupo = element.closest(".produto-group");
    const peso = parseFloat(grupo.querySelector(".pesoLiquido").value) || 0;
    const volume = parseFloat(grupo.querySelector(".volumeTotalCarga").value) || 0;
    grupo.querySelector(".pesoBruto").value = (peso * volume).toFixed(2);
  }

  function removerProduto(btn) { btn.closest(".produto-group").remove(); }

  function adicionarBobina(containerBtn) {
    let container = containerBtn.classList && containerBtn.classList.contains("bobinas-container")
      ? containerBtn
      : containerBtn.previousElementSibling;
    const div = document.createElement("div");
    div.classList.add("bobina-group");
    div.innerHTML = `
      <select>
        <option value="">Selecione a Bobina</option>
        <option value="FSC">FSC</option>
        <option value="SUZANO">SUZANO</option>
        <option value="KLABIN">KLABIN</option>
      </select>
      <input type="text" placeholder="Lote da Bobina" />
      <button type="button" class="remove-bobina-btn" onclick="removerBobina(this)">Remover</button>
    `;
    container.appendChild(div);
  }

  function removerBobina(btn) { btn.parentElement.remove(); }

  async function salvarRegistros() {
    const cliente = document.getElementById("cliente").value.trim();
    const numeroOS = document.getElementById("numeroOS").value.trim(); // Novo campo
    const user = auth.currentUser;
    if (!cliente || !user) {
      alert("Preencha o cliente e esteja logado.");
      return;
    }

    const gruposProdutos = document.querySelectorAll(".produto-group");
    const promessas = [];

    gruposProdutos.forEach(grupo => {
      const numeroNotaFiscal = grupo.querySelector(".numeroNotaFiscal").value.trim();
      const tipoEmbalagem = grupo.querySelector(".tipoEmbalagem").value.trim();
      const produto = grupo.querySelector(".produto").value.trim();
      const dimensaoEmbalagem = grupo.querySelector(".dimensaoEmbalagem").value.trim();
      const pesoLiquido = parseFloat(grupo.querySelector(".pesoLiquido").value) || 0;
      const pesoBruto = parseFloat(grupo.querySelector(".pesoBruto").value) || 0;
      const volumeTotalCarga = parseFloat(grupo.querySelector(".volumeTotalCarga").value) || 0;

      const bobinas = [];
      grupo.querySelectorAll(".bobina-group").forEach(group => {
        const tipo = group.querySelector("select").value.trim();
        const lote = group.querySelector("input").value.trim();
        if (tipo && lote) bobinas.push({ tipo, lote });
      });

      if (numeroNotaFiscal && tipoEmbalagem && produto && bobinas.length > 0) {
        const registro = {
          cliente,
          numeroOS,  // campo novo salvo aqui
          numeroNotaFiscal,
          tipoEmbalagem,
          produto,
          dimensaoEmbalagem,
          pesoLiquido,
          pesoBruto,
          volumeTotalCarga,
          bobinas,
          criadoPor: user.email,
          data: firebase.firestore.FieldValue.serverTimestamp()
        };
        promessas.push(db.collection("bobinas").add(registro));
      }
    });

    if (promessas.length === 0) {
      alert("Preencha pelo menos um produto com suas bobinas corretamente, incluindo Nota Fiscal e Tipo de Embalagem.");
      return;
    }

    try {
      await Promise.all(promessas);
      produtosContainer.innerHTML = "";
      adicionarProduto();
      alert("Registros salvos com sucesso!");
    } catch (error) {
      console.error("Erro ao salvar:", error);
      alert("Erro ao salvar: " + error.message);
    }
  }

  function carregarRegistrosEmTempoReal() {
    db.collection("bobinas").orderBy("data", "desc")
      .onSnapshot(snapshot => {
        registros = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        atualizarTabela();
        atualizarFiltro();
      });
  }

  function atualizarTabela() {
    const tbody = document.querySelector("#tabelaRegistros tbody");
    tbody.innerHTML = "";
    registros.forEach(reg => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${reg.cliente}</td>
        <td>${reg.numeroOS || ""}</td> <!-- coluna nova -->
        <td>${reg.numeroNotaFiscal || ""}</td>
        <td>${reg.tipoEmbalagem || ""}</td>
        <td>${reg.produto}</td>
        <td>${reg.dimensaoEmbalagem || ""}</td>
        <td>${reg.pesoLiquido?.toFixed(2) || ""}</td>
        <td>${reg.pesoBruto?.toFixed(2) || ""}</td>
        <td>${reg.volumeTotalCarga || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function atualizarFiltro() {
    const filtroCliente = document.getElementById("filtroCliente");
    const filtroVenda = document.getElementById("filtroVenda");

    const clientes = [...new Set(registros.map(r => r.cliente))];
    const vendas = [...new Set(registros.map(r => r.numeroNotaFiscal))];

    filtroCliente.innerHTML = `<option value="">Todos</option>` + clientes.map(c => `<option>${c}</option>`).join("");
    filtroVenda.innerHTML = `<option value="">Todos</option>` + vendas.map(v => `<option>${v}</option>`).join("");
  }

  function filtrarTabela() {
    const clienteFiltro = document.getElementById("filtroCliente").value;
    const vendaFiltro = document.getElementById("filtroVenda").value;
    const tbody = document.querySelector("#tabelaRegistros tbody");

    tbody.innerHTML = "";
    registros.forEach(reg => {
      if ((clienteFiltro === "" || reg.cliente === clienteFiltro) &&
          (vendaFiltro === "" || reg.numeroNotaFiscal === vendaFiltro)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${reg.cliente}</td>
          <td>${reg.numeroOS || ""}</td>
          <td>${reg.numeroNotaFiscal || ""}</td>
          <td>${reg.tipoEmbalagem || ""}</td>
          <td>${reg.produto}</td>
          <td>${reg.dimensaoEmbalagem || ""}</td>
          <td>${reg.pesoLiquido?.toFixed(2) || ""}</td>
          <td>${reg.pesoBruto?.toFixed(2) || ""}</td>
          <td>${reg.volumeTotalCarga || ""}</td>
        `;
        tbody.appendChild(tr);
      }
    });
  }

  function imprimirClienteSelecionado() {
    
    const clienteFiltro = document.getElementById("filtroCliente").value;
    const vendaFiltro = document.getElementById("filtroVenda").value;

    const registrosFiltrados = registros.filter(reg =>
      (clienteFiltro === "" || reg.cliente === clienteFiltro) &&
      (vendaFiltro === "" || reg.numeroNotaFiscal === vendaFiltro)
    );

    if (registrosFiltrados.length === 0) {
      alert("Nenhum registro para imprimir com os filtros selecionados.");
      return;
    }

    let html = `
      <html>
      <head>
        <title>Impressão de Registros</title>
        <style>
          body { font-family: Arial; padding: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #000; padding: 8px; text-align: center; }
          th { background-color: #eee; }
  
  }
}

        </style>
      </head>
      <body>
        <img src="./IMG/logo_kurma.jpg" alt="Logo" style="display:block; margin: 0 auto 15px auto; width: 200px; height: auto;" />

        <h2>ROMANEIO</h2>
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Número da OS</th>
              <th>Número da Nota Fiscal</th>
              <th>Tipo de Embalagem</th>
              <th>Produto</th>
              <th>Dimensão da Embalagem (LxC)</th>
              <th>Peso Líquido (unit.)</th>
              <th>Peso Bruto</th>
              <th>Volume Total da Carga</th>
            </tr>
          </thead>
          <tbody>
    `;
    

    registrosFiltrados.forEach(reg => {
      html += `
        <tr>
          <td>${reg.cliente}</td>
          <td>${reg.numeroOS || ""}</td>
          <td>${reg.numeroNotaFiscal || ""}</td>
          <td>${reg.tipoEmbalagem || ""}</td>
          <td>${reg.produto}</td>
          <td>${reg.dimensaoEmbalagem || ""}</td>
          <td>${reg.pesoLiquido?.toFixed(2) || ""}</td>
          <td>${reg.pesoBruto?.toFixed(2) || ""}</td>
          <td>${reg.volumeTotalCarga || ""}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </body>
      </html>
    `;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
    win.close();
  }

  // Inicializa com um produto já para facilitar
  adicionarProduto();
</script>
</body>
</html>
